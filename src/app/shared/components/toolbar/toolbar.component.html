<div
  class="c-toolbar"
  [class.c-toolbar--expanded]="expanded()"
>
  <!-- ====== Header row ====== -->
  <div class="c-toolbar__header">
    <div class="c-toolbar__title-group">
      <h3 class="c-toolbar__title">Filtres</h3>
      <p-tag [value]="'' + activeFilterCount()" [rounded]="true" severity="secondary" />
    </div>

    <div class="c-toolbar__header-actions">
      <!-- Search input -->
      <div class="c-toolbar__search">
        <p-iconfield iconPosition="left">
          <p-inputicon styleClass="pi pi-search" />
          <input
            type="text"
            pInputText
            [placeholder]="searchPlaceholder()"
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
            class="c-toolbar__search-input"
          />
        </p-iconfield>
        @if (searchQuery()) {
          <button type="button" class="c-toolbar__search-clear" (click)="searchQuery.set('')" aria-label="Effacer">
            <i class="pi pi-times"></i>
          </button>
        }
      </div>

      <!-- Saved filter picker: SelectButton or Select (hidden when none saved) -->
      @if (savedFilters().length > 0) {
        <div class="c-toolbar__filter-buttons">
          @if (!useDropdown()) {
            <p-selectbutton
              [options]="filterOptions()"
              [ngModel]="selectedFilterId()"
              (ngModelChange)="onFilterSelect($event)"
              optionLabel="label"
              optionValue="value"
            />
          } @else {
            <p-select
              [options]="filterOptions()"
              [ngModel]="selectedFilterId()"
              (ngModelChange)="onFilterSelect($event)"
              optionLabel="label"
              optionValue="value"
              placeholder="Choisir un filtre"
              styleClass="c-toolbar__filter-select"
            />
          }
        </div>
      }

      <!-- Toggle expand/collapse -->
      <button
        type="button"
        class="c-toolbar__toggle"
        (click)="toggleExpanded()"
        [attr.aria-label]="expanded() ? 'Réduire les filtres' : 'Étendre les filtres'"
        [attr.aria-expanded]="expanded()"
      >
        <i class="pi" [class.pi-angle-up]="expanded()" [class.pi-angle-down]="!expanded()"></i>
      </button>
    </div>
  </div>

  <!-- ====== Expanded body ====== -->
  @if (expanded()) {
    <hr class="u-separator" />

    <div class="c-toolbar__body">
      <!-- Row 1: Autocomplete filter fields -->
      @for (filter of autocompleteFilters; track filter.id) {
        <div class="c-toolbar__field">
          <label class="c-toolbar__field-label" [attr.for]="'filter-' + filter.id">
            {{ filter.label }}
          </label>
          <p-autocomplete
            [(ngModel)]="filter.selectedValues"
            [suggestions]="filteredSuggestions"
            (completeMethod)="onAutocompleteSuggest($event, filter)"
            [multiple]="true"
            [dropdown]="true"
            [showClear]="true"
            [inputId]="'filter-' + filter.id"
          />
        </div>
      }
      <!-- Empty 4th cell in row 1 -->
      <div class="c-toolbar__field c-toolbar__field--empty"></div>

      <!-- Separator spanning all 4 columns -->
      <hr class="u-separator u-separator--full-row" />

      <!-- Row 2: Toggle-switch filters -->
      @for (toggle of toggleFilters; track toggle.id) {
        <div class="c-toolbar__field">
          <label class="c-toolbar__field-label" [attr.for]="'toggle-' + toggle.id">
            {{ toggle.label }}
          </label>
          <p-toggleswitch
            [(ngModel)]="toggle.value"
            [inputId]="'toggle-' + toggle.id"
          />
        </div>
      }
    </div>

    <!-- ====== Footer ====== -->
    <hr class="u-separator" />

    <div class="c-toolbar__footer">
      <p-button
        label="Appliquer"
        icon="bi bi-check-lg"
        (onClick)="onApply()"
      />
      <p-button
        label="Sauvegarder et appliquer"
        icon="bi bi-floppy"
        (onClick)="onSaveAndApply()"
      />
      <p-button
        label="Renommer"
        icon="bi bi-pencil"
        severity="secondary"
        [outlined]="true"
        [disabled]="!hasSelectedFilter()"
        (onClick)="onRename()"
      />
      <p-button
        label="Supprimer"
        icon="bi bi-trash3"
        severity="secondary"
        [outlined]="true"
        [disabled]="!hasSelectedFilter()"
        (onClick)="onDelete()"
      />
      <p-button
        label="Annuler"
        icon="bi bi-x-lg"
        severity="secondary"
        [outlined]="true"
        (onClick)="onCancel()"
      />
    </div>
  }
</div>

<!-- ====== Save filter dialog ====== -->
<p-dialog
  header="Sauvegarder le filtre"
  [visible]="showSaveDialog()"
  (visibleChange)="showSaveDialog.set($event)"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
>
  <div class="c-toolbar__save-dialog-body">
    <label class="c-toolbar__field-label" for="save-filter-name">Nom du filtre</label>
    <input
      id="save-filter-name"
      type="text"
      pInputText
      [ngModel]="saveFilterName()"
      (ngModelChange)="saveFilterName.set($event)"
      placeholder="Ex: Mes dossiers urgents"
      class="c-toolbar__save-dialog-input"
      (keydown.enter)="onConfirmSave()"
    />
    @if (duplicateExists()) {
      <small class="c-toolbar__save-dialog-hint">
        Ce nom existe déjà. Choisissez un autre nom ou remplacez le filtre existant.
      </small>
    }
  </div>
  <ng-template #footer>
    <div class="c-toolbar__save-dialog-footer">
      <p-button
        label="Annuler"
        severity="secondary"
        [outlined]="true"
        (onClick)="showSaveDialog.set(false)"
      />
      @if (duplicateExists()) {
        <p-button
          label="Remplacer"
          icon="bi bi-arrow-repeat"
          (onClick)="onReplace()"
        />
      } @else {
        <p-button
          label="Sauvegarder"
          icon="bi bi-floppy"
          [disabled]="!saveFilterName().trim()"
          (onClick)="onConfirmSave()"
        />
      }
    </div>
  </ng-template>
</p-dialog>

<!-- ====== Delete confirmation dialog ====== -->
<p-dialog
  header="Supprimer le filtre"
  [visible]="showDeleteDialog()"
  (visibleChange)="showDeleteDialog.set($event)"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
>
  <p class="c-toolbar__dialog-message">
    Voulez-vous vraiment supprimer le filtre <strong>{{ selectedFilterName() }}</strong> ?
  </p>
  <ng-template #footer>
    <div class="c-toolbar__save-dialog-footer">
      <p-button
        label="Annuler"
        severity="secondary"
        [outlined]="true"
        (onClick)="showDeleteDialog.set(false)"
      />
      <p-button
        label="Supprimer"
        icon="bi bi-trash3"
        severity="danger"
        (onClick)="onConfirmDelete()"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- ====== Rename filter dialog ====== -->
<p-dialog
  header="Renommer le filtre"
  [visible]="showRenameDialog()"
  (visibleChange)="showRenameDialog.set($event)"
  [modal]="true"
  [style]="{ width: '400px' }"
  [closable]="true"
>
  <div class="c-toolbar__save-dialog-body">
    <label class="c-toolbar__field-label" for="rename-filter-name">Nouveau nom</label>
    <input
      id="rename-filter-name"
      type="text"
      pInputText
      [ngModel]="renameFilterName()"
      (ngModelChange)="renameFilterName.set($event)"
      placeholder="Ex: Mes dossiers urgents"
      class="c-toolbar__save-dialog-input"
      (keydown.enter)="onConfirmRename()"
    />
    @if (renameDuplicateExists()) {
      <small class="c-toolbar__save-dialog-hint">
        Ce nom est déjà utilisé par un autre filtre.
      </small>
    }
  </div>
  <ng-template #footer>
    <div class="c-toolbar__save-dialog-footer">
      <p-button
        label="Annuler"
        severity="secondary"
        [outlined]="true"
        (onClick)="showRenameDialog.set(false)"
      />
      <p-button
        label="Renommer"
        icon="bi bi-pencil"
        [disabled]="!renameFilterName().trim() || renameDuplicateExists()"
        (onClick)="onConfirmRename()"
      />
    </div>
  </ng-template>
</p-dialog>
